# TidyBot2 仿真环境使用指南

## 🎯 概述

本指南将帮助你快速搭建和使用TidyBot2仿真环境，用于测试不同的运控算法控制器在遥控中的表现。

## 🚀 快速开始

### 1. 环境搭建

确保已按照主README文档完成环境搭建：

```bash
# 激活环境
eval "$(mamba shell hook --shell bash)" && mamba activate tidybot2

# 验证安装
python -c "import mujoco; print('MuJoCo版本:', mujoco.__version__)"
```

### 2. 基础测试

#### 测试仿真环境
```bash
# 基本功能测试
python -c "
from mujoco_env import MujocoEnv
env = MujocoEnv(show_images=False)
env.reset()
print('仿真环境测试成功！')
env.close()
"
```

#### 测试手机遥控接口
```bash
# 启动遥控服务器（会显示服务器地址）
python -c "
from policies import TeleopPolicy
import time
policy = TeleopPolicy()
print('遥控服务器已启动，请用手机访问显示的地址')
time.sleep(10)  # 运行10秒后自动停止
"
```

## 📱 手机遥控设置

### 1. 连接步骤
1. 确保手机和电脑连接到同一WiFi网络
2. 运行包含`TeleopPolicy`的程序
3. 程序会显示服务器地址，如：`Starting server at 192.168.1.100:5000`
4. 在手机浏览器中访问该地址
5. 允许浏览器访问设备传感器权限

### 2. 操作说明
- **开始操作**：点击"Start episode"
- **底盘控制**：选择"Base mode"，移动手机控制底盘位置和角度
- **机械臂控制**：选择"Arm mode"，移动手机控制机械臂末端位置
- **夹爪控制**：在机械臂模式下，使用屏幕上的夹爪滑块
- **结束操作**：点击"End episode"
- **重置环境**：点击"Reset env"

## 🛠️ 控制器测试工具

我们提供了专门的控制器测试脚本 `test_controllers.py`：

### 基本使用

```bash
# 基本控制测试（30秒手机遥控）
python test_controllers.py --test basic --duration 30

# 精确控制测试（自动移动到预设目标点）
python test_controllers.py --test precision

# 轨迹跟踪测试（执行圆形轨迹）
python test_controllers.py --test trajectory

# 完整测试套件
python test_controllers.py --test all
```

### 高级选项

```bash
# 不显示仿真窗口（适用于服务器环境）
python test_controllers.py --test basic --no-images

# 不记录数据（提高性能）
python test_controllers.py --test basic --no-record

# 保存测试结果图表
python test_controllers.py --test basic --save-plot results.png

# 自定义测试时长
python test_controllers.py --test basic --duration 60
```

## 📊 测试类型详解

### 1. 基本控制测试 (`--test basic`)
- **目的**：测试遥控响应性和基本控制精度
- **方法**：使用手机进行遥控操作
- **测量指标**：
  - 位置跟踪精度
  - 响应延迟
  - 控制稳定性
- **结果**：生成位置跟踪曲线和误差分析图

### 2. 精确控制测试 (`--test precision`)
- **目的**：测试控制器到达指定位置的精度
- **方法**：自动移动到4个预设目标点
- **测量指标**：
  - 到达精度（底盘和机械臂）
  - 到达时间
  - 成功率
- **结果**：每个目标点的精度统计

### 3. 轨迹跟踪测试 (`--test trajectory`)
- **目的**：测试复杂轨迹的跟踪能力
- **方法**：执行预定义的圆形轨迹
- **测量指标**：
  - 平均跟踪误差
  - 最大跟踪误差
  - 轨迹光滑度
- **结果**：轨迹误差统计和可视化

## 🔧 自定义控制器测试

### 修改控制参数

编辑相关文件中的控制参数：

```python
# 在 constants.py 中修改基本参数
POLICY_CONTROL_FREQ = 10  # 控制频率 (Hz)

# 在 base_controller.py 中修改底盘参数
max_vel = (0.5, 0.5, 1.57)      # 最大速度 (m/s, m/s, rad/s)
max_accel = (0.25, 0.25, 0.79)  # 最大加速度

# 在 arm_controller.py 中修改机械臂参数
K_p = np.diag([100.0, 100.0, 100.0, 100.0, 50.0, 50.0, 50.0])  # 位置增益
K_d = np.diag([3.0, 3.0, 3.0, 3.0, 2.0, 2.0, 2.0])             # 速度增益
```

### 添加自定义测试

在 `test_controllers.py` 中添加新的测试方法：

```python
def test_custom_algorithm(self):
    """自定义算法测试"""
    print("执行自定义算法测试...")
    
    # 实现你的测试逻辑
    # ...
    
    return test_results
```

## 📈 结果分析

### 性能指标

1. **位置精度**：
   - 底盘位置误差 < 2cm（优秀）
   - 机械臂位置误差 < 1cm（优秀）

2. **响应时间**：
   - 控制延迟 < 100ms（优秀）
   - 到达时间 < 5s（优秀）

3. **稳定性**：
   - 位置波动 < 1mm（稳定）
   - 无振荡现象

### 结果图表解读

生成的图表包含4个子图：

1. **底盘位置跟踪**：显示X、Y坐标的目标值vs实际值
2. **底盘角度跟踪**：显示角度的目标值vs实际值  
3. **机械臂位置跟踪**：显示X、Y、Z坐标的目标值vs实际值
4. **跟踪误差**：显示底盘和机械臂的位置误差随时间变化

## 🐛 故障排除

### 常见问题

1. **MuJoCo窗口显示问题**
   ```bash
   # 解决方案：使用无头模式
   python test_controllers.py --no-images
   ```

2. **手机连接失败**
   - 检查防火墙设置
   - 确保手机和电脑在同一网络
   - 尝试使用IP地址而非localhost

3. **控制响应慢**
   - 检查网络延迟
   - 降低控制频率
   - 关闭不必要的程序

4. **仿真卡顿**
   ```bash
   # 降低图像质量或关闭图像显示
   python test_controllers.py --no-images
   ```

### 性能优化

1. **提高仿真性能**：
   - 使用 `--no-images` 选项
   - 降低控制频率
   - 关闭数据记录 `--no-record`

2. **提高控制精度**：
   - 调整PID参数
   - 增加控制频率
   - 优化网络环境

## 📚 进阶使用

### 1. 批量测试

创建批量测试脚本：

```bash
#!/bin/bash
# batch_test.sh

echo "开始批量测试..."

# 测试不同控制频率
for freq in 5 10 20; do
    echo "测试控制频率: ${freq}Hz"
    # 修改constants.py中的POLICY_CONTROL_FREQ
    python test_controllers.py --test all --save-plot "results_${freq}hz.png"
done

echo "批量测试完成"
```

### 2. 数据分析

使用Python分析测试数据：

```python
import numpy as np
import matplotlib.pyplot as plt

# 加载测试数据
data = np.load('test_results.npy', allow_pickle=True).item()

# 计算统计指标
mean_error = np.mean(data['errors'])
std_error = np.std(data['errors'])
max_error = np.max(data['errors'])

print(f"平均误差: {mean_error:.4f}m")
print(f"误差标准差: {std_error:.4f}m") 
print(f"最大误差: {max_error:.4f}m")
```

### 3. 实时监控

实现实时性能监控：

```python
import time
from collections import deque

class PerformanceMonitor:
    def __init__(self, window_size=100):
        self.errors = deque(maxlen=window_size)
        self.times = deque(maxlen=window_size)
    
    def update(self, error, timestamp):
        self.errors.append(error)
        self.times.append(timestamp)
    
    def get_stats(self):
        if not self.errors:
            return None
        return {
            'mean_error': np.mean(self.errors),
            'max_error': np.max(self.errors),
            'error_trend': np.polyfit(range(len(self.errors)), self.errors, 1)[0]
        }
```

## 🎓 学习资源

### 相关论文
- [TidyBot++ Paper](http://tidybot2.github.io/paper.pdf)
- [Diffusion Policy](https://diffusion-policy.cs.columbia.edu/)

### 技术文档
- [MuJoCo Documentation](https://mujoco.readthedocs.io/)
- [Ruckig Trajectory Generation](https://github.com/pantor/ruckig)
- [Kinova Gen3 API](https://github.com/Kinovarobotics/kortex)

### 社区支持
- [项目主页](http://tidybot2.github.io)
- [GitHub Issues](https://github.com/jimmyyhwu/tidybot2/issues)

---

**提示**：在进行控制器测试时，建议先从简单的测试开始，逐步增加复杂度。记录详细的测试日志有助于问题诊断和性能优化。 