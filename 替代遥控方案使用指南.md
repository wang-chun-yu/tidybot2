# TidyBot2 替代遥控方案使用指南

## 🎯 概述

由于WebXR主要在iOS Safari上支持良好，Android设备支持有限，我们提供了多个替代遥控方案来解决设备兼容性问题。

## 🚀 方案一：键盘遥控（推荐用于开发测试）

### 特点
- ✅ **零依赖**：无需额外硬件，任何有键盘的设备都可使用
- ✅ **精确控制**：步进式控制，适合精确操作
- ✅ **开发友好**：适合算法开发和调试
- ❌ **操作体验**：不如手柄或触摸直观

### 使用方法

#### 1. 独立测试
```bash
# 激活环境
eval "$(mamba shell hook --shell bash)" && mamba activate tidybot2

# 启动键盘遥控测试
python keyboard_teleop.py --no-images
```

#### 2. 集成到main.py
```bash
# 修改policies.py添加KeyboardTeleopPolicy
# 然后运行
python main.py --sim --policy keyboard_teleop
```

### 控制说明
```
通用控制:
  [Tab]     - 切换控制模式 (底盘/机械臂)
  [Space]   - 开始/结束操作
  [R]       - 重置环境
  [ESC]     - 退出程序

底盘控制模式 (🚗):
  [W/S]     - 前进/后退
  [A/D]     - 左移/右移
  [Q/E]     - 左转/右转

机械臂控制模式 (🦾):
  [W/S]     - X轴 前/后
  [A/D]     - Y轴 左/右
  [Q/E]     - Z轴 上/下
  [Z/X]     - 夹爪 开/合
```

## 🎮 方案二：游戏手柄遥控（推荐用于实际操作）

### 特点
- ✅ **直观操作**：双摇杆设计，操作自然流畅
- ✅ **精确控制**：模拟量输入，支持连续控制
- ✅ **专业体验**：类似专业机器人操作台
- ❌ **硬件需求**：需要游戏手柄（Xbox、PS4等）

### 硬件要求
- **支持的手柄**：Xbox One/Series、PS4/PS5、通用USB手柄
- **连接方式**：USB有线连接（推荐）或蓝牙无线
- **操作系统**：Linux（已测试）、Windows、macOS

### 安装依赖
```bash
# 安装pygame（如果未安装）
pip install pygame
```

### 使用方法

#### 1. 连接手柄
```bash
# 检查手柄是否被识别
lsusb | grep -i "xbox\|playstation\|controller"

# 或者使用jstest测试（需要安装joystick工具）
sudo apt install joystick
jstest /dev/input/js0
```

#### 2. 启动手柄遥控
```bash
# 独立测试
python gamepad_teleop_advanced.py --no-images

# 集成运行
python main.py --sim --policy gamepad_teleop
```

### 控制说明
```
通用控制:
  Start按钮    - 开始/结束操作
  Select按钮   - 重置环境
  Y/△按钮     - 切换控制模式
  A/×按钮     - 退出程序

底盘控制模式 (🚗):
  左摇杆      - 前后左右移动
  右摇杆X轴   - 旋转

机械臂控制模式 (🦾):
  左摇杆      - X/Y轴移动
  右摇杆Y轴   - Z轴移动
  LT/RT扳机   - 夹爪开合
```

### 故障排除
```bash
# 如果手柄未被识别
sudo chmod 666 /dev/input/js*

# 检查pygame是否能检测到手柄
python -c "import pygame; pygame.init(); pygame.joystick.init(); print(f'检测到 {pygame.joystick.get_count()} 个手柄')"
```

## 📱 方案三：Android兼容Web界面（完善版）

### 特点
- ✅ **广泛兼容**：支持Android、iOS、桌面浏览器
- ✅ **移动友好**：触摸操作，虚拟摇杆，响应式设计
- ✅ **传感器增强**：使用设备方向传感器和加速度计
- ✅ **性能优化**：数据压缩、延迟优化、电池优化
- ✅ **视觉反馈**：实时相机视图、状态监控、性能指标
- ❌ **网络依赖**：需要稳定的WiFi连接

### 技术架构
- **前端界面**：响应式Web界面，支持触摸和传感器
- **虚拟摇杆**：高精度触摸控制，替代WebXR位置追踪
- **设备传感器**：方向传感器提供旋转控制
- **实时通信**：WebSocket + SocketIO，低延迟数据传输
- **性能监控**：实时FPS、延迟、CPU/内存使用率监控
- **相机视图**：双相机实时视频流（底盘+腕部）

### 完整功能列表

#### 🎮 控制功能
- **双模式控制**：底盘移动 + 机械臂操作
- **虚拟摇杆**：精确的触摸控制
- **传感器融合**：设备倾斜控制旋转/Z轴
- **夹爪控制**：滑块精确控制 + 快捷按钮
- **触觉反馈**：震动反馈（支持设备）

#### 📊 监控功能
- **实时状态**：连接状态、机器人状态、操作模式
- **性能指标**：FPS、延迟、数据包计数
- **电池监控**：设备电量显示
- **网络状态**：连接质量、数据传输统计

#### 📷 视觉功能
- **双相机视图**：底盘相机 + 腕部相机
- **实时视频流**：低延迟视频传输
- **十字瞄准**：辅助定位功能
- **全屏模式**：沉浸式视觉体验

### 使用方法

#### 1. 基础版启动
```bash
# 启动基础Android遥控服务器
python android_teleop_server.py --no-images

# 或集成到主程序
python main.py --sim --policy android_teleop
```

#### 2. 增强版启动（推荐）
```bash
# 启动性能优化版服务器
python android_teleop_optimized.py --no-images

# 自定义端口和配置
python android_teleop_optimized.py --port 5001 --debug
```

#### 3. 连接设备
1. **WiFi连接**：确保手机和电脑在同一网络
2. **访问地址**：在手机浏览器输入显示的IP地址
3. **权限授予**：允许浏览器访问设备传感器和相机
4. **开始操作**：点击"开始操作"按钮

#### 4. 多界面访问
```
主控界面：  http://IP:5000/
相机视图：  http://IP:5000/camera  
状态监控：  http://IP:5000/status
健康检查：  http://IP:5000/health
```

### 控制说明

#### 🎮 基本操作
- **模式切换**：点击"底盘控制"/"机械臂控制"按钮
- **开始/停止**：点击绿色"开始操作"按钮
- **重置环境**：点击"重置环境"按钮
- **设置配置**：点击"设置"按钮

#### 🕹️ 底盘控制模式
- **前后左右移动虚拟摇杆**：
  1. 触摸拖拽控制前后左右移动
  2. 移动速度固定，由移动速度滑动条调节
  3. 手指离开摇杆，或者回中时，停止移动
- **移动速度滑动条**：调节前后左右移动最大速度
- **旋转按钮**: 
  1. 旋转按钮为圆形结构，左半圆为顺时针旋转按钮，右半圆为逆时针旋转按钮，
  2. 旋转速度固定，由旋转速度活动条调节
  3. 手指停止按钮，停止旋转   
- **旋转速度滑动调**：调节旋转最大速度
- **精确控制**：

#### 🦾 机械臂控制模式
- **虚拟摇杆**：控制X/Y轴位置
- **设备倾斜**：前后倾斜控制Z轴高度
- **夹爪控制**：
  - 滑动控制条：精确调节开合度
  - +/- 按钮：快速调节
  - 实时数值显示

#### 📱 传感器功能
- **方向传感器**：实时显示α/β/γ角度
- **加速度计**：检测设备运动状态
- **自动校准**：支持传感器零点校准
- **权限管理**：iOS设备需要手动授权

### 性能优化特性

#### ⚡ 延迟优化
- **异步处理**：后台消息队列处理
- **数据压缩**：WebSocket数据压缩
- **智能缓存**：避免重复数据处理
- **预测补偿**：延迟预测和补偿

#### 🔋 电池优化
- **自适应频率**：根据电量调整更新频率
- **省电模式**：低电量时自动降低性能
- **后台优化**：页面隐藏时暂停非必要功能
- **连接管理**：智能重连和心跳优化

#### 📊 性能监控
- **实时指标**：CPU、内存、网络使用率
- **历史统计**：性能趋势分析
- **自动调优**：根据设备能力自动调整参数
- **错误恢复**：自动错误检测和恢复

### 测试和验证

#### 🧪 功能测试
```bash
# 运行完整功能测试
python test_android_interface.py --port 5000

# 测试特定功能
python test_android_interface.py --host 192.168.1.100 --port 5001
```

#### 📋 测试项目
- **HTTP端点测试**：主页、状态接口、健康检查
- **WebSocket连接测试**：连接稳定性、消息传输
- **性能测试**：延迟测试、吞吐量测试
- **错误处理测试**：异常恢复、连接重建
- **移动特性测试**：传感器数据、电池状态

### 故障排除

#### 🔧 常见问题
1. **连接失败**
   ```bash
   # 检查防火墙设置
   sudo ufw allow 5000
   
   # 检查服务器状态
   curl http://localhost:5000/health
   ```

2. **传感器不工作**
   - iOS：需要HTTPS或用户手动授权
   - Android：检查浏览器权限设置
   - 桌面：传感器API可能不支持

3. **延迟过高**
   - 使用5GHz WiFi网络
   - 关闭其他网络应用
   - 启用性能优化模式

4. **视频流问题**
   - 检查相机权限设置
   - 降低视频质量设置
   - 使用有线网络连接

### 高级配置

#### ⚙️ 服务器配置
```python
# 自定义服务器配置
server = OptimizedAndroidTeleopServer(
    host='0.0.0.0',
    port=5000,
    debug=False
)

# 性能参数调整
server.controller.update_rate = 30  # 30Hz更新
server.controller.max_position_change = 0.05  # 更精确控制
```

#### 📱 客户端优化
```javascript
// 请求特定优化模式
socket.emit('request_optimization', {
    type: 'high_performance'  // 或 'low_power', 'balanced'
});

// 自定义更新频率
socket.emit('set_update_rate', {rate: 25});
```

## 🔧 集成到主程序

### 修改policies.py
```python
# 在policies.py中添加新的策略类
from keyboard_teleop import KeyboardTeleopPolicy
from gamepad_teleop_advanced import GamepadTeleopPolicy

# 在Policy类工厂中添加选项
def create_policy(policy_type):
    if policy_type == 'keyboard':
        return KeyboardTeleopPolicy()
    elif policy_type == 'gamepad':
        return GamepadTeleopPolicy()
    elif policy_type == 'teleop':
        return TeleopPolicy()
    # ... 其他策略
```

### 修改main.py
```python
# 添加命令行参数
parser.add_argument('--policy', default='teleop', 
                   choices=['teleop', 'keyboard', 'gamepad'],
                   help='选择遥控策略')

# 在主函数中使用
policy = create_policy(args.policy)
```

## 📊 方案对比

| 特性 | 键盘遥控 | 游戏手柄 | Android Web |
|------|----------|----------|-------------|
| **设备要求** | 键盘 | 游戏手柄 | 智能手机 |
| **操作精度** | 高（步进） | 很高（连续） | 中（触摸） |
| **学习成本** | 低 | 中 | 低 |
| **开发调试** | 最佳 | 好 | 一般 |
| **实际操作** | 一般 | 最佳 | 好 |
| **移动性** | 差 | 中 | 最佳 |

## 🎯 使用建议

### 开发阶段
- **算法开发**：使用键盘遥控，便于调试
- **功能测试**：使用游戏手柄，接近真实操作
- **演示展示**：使用Android Web界面，便于移动

### 生产环境
- **专业操作员**：游戏手柄遥控
- **临时用户**：Android Web界面
- **紧急情况**：键盘遥控（备用方案）

## 🚨 注意事项

### 安全提示
1. **测试环境**：首先在仿真环境测试所有控制方案
2. **权限控制**：确保只有授权人员可以访问遥控接口
3. **网络安全**：Web界面应在可信网络环境使用
4. **应急停止**：所有方案都支持快速停止操作

### 性能优化
1. **降低延迟**：有线连接优于无线连接
2. **稳定网络**：Web方案需要稳定的WiFi环境
3. **资源管理**：及时关闭不使用的遥控接口

### 故障排除
1. **设备识别问题**：检查驱动和权限设置
2. **网络连接问题**：确认防火墙和网络配置
3. **性能问题**：关闭不必要的图形渲染

## 📝 总结

我们提供了三种完整的替代遥控方案，每种都有其适用场景：

1. **键盘遥控**：开发测试的最佳选择
2. **游戏手柄遥控**：实际操作的专业方案  
3. **Android Web界面**：移动友好的通用方案

所有方案都经过测试，可以立即使用。选择最适合你需求的方案，开始你的机器人控制之旅！ 