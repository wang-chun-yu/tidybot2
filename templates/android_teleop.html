<!-- AndroidÂÖºÂÆπÁöÑTidyBot2ÈÅ•ÊéßÁïåÈù¢ -->
<!-- ‰ΩøÁî®ËÆæÂ§áÊñπÂêë‰º†ÊÑüÂô®Êõø‰ª£WebXRÔºåÊîØÊåÅÊõ¥Â§öËÆæÂ§á -->

<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <title>TidyBot2 Android ÈÅ•Êéß</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            touch-action: none;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .header {
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .status {
            font-size: 14px;
            margin: 5px 0;
        }

        .controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .mode-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .mode-btn.inactive {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .control-area {
            flex: 1;
            display: flex;
            gap: 15px;
            padding: 20px;
        }

        .joystick-container {
            flex: 1;
            position: relative;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .joystick {
            width: 120px;
            height: 120px;
            background: rgba(255,255,255,0.1);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }

        .joystick-knob {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 120px;
        }

        .control-btn {
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .control-btn:active {
            background: #FF5722;
            transform: scale(0.95);
        }

        .gripper-control {
            margin-top: 20px;
        }

        .gripper-slider {
            width: 100%;
            height: 40px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            outline: none;
        }

        .gripper-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }

        .sensor-info {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        @media (orientation: landscape) {
            .control-area {
                flex-direction: row;
            }
        }

        @media (orientation: portrait) {
            .control-area {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>ü§ñ TidyBot2 ÈÅ•Êéß</h2>
            <div class="status" id="connection-status">ËøûÊé•‰∏≠...</div>
            <div class="status" id="rtt-info">Âª∂Ëøü: -- ms</div>
        </div>

        <div class="controls">
            <!-- Ê®°ÂºèÈÄâÊã© -->
            <div class="mode-selector">
                <button class="mode-btn active" id="base-mode-btn" onclick="switchMode('base')">
                    üöó Â∫ïÁõòÊéßÂà∂
                </button>
                <button class="mode-btn inactive" id="arm-mode-btn" onclick="switchMode('arm')">
                    ü¶æ Êú∫Ê¢∞ËáÇÊéßÂà∂
                </button>
            </div>

            <!-- ÊéßÂà∂Âå∫Âüü -->
            <div class="control-area">
                <!-- ËôöÊãüÊëáÊùÜ -->
                <div class="joystick-container">
                    <div class="joystick" id="joystick">
                        <div class="joystick-knob" id="joystick-knob"></div>
                    </div>
                    <div style="position: absolute; bottom: 10px; font-size: 12px; text-align: center; width: 100%;">
                        <span id="joystick-label">ÁßªÂä®ÊéßÂà∂</span>
                    </div>
                </div>

                <!-- ÊéßÂà∂ÊåâÈíÆ -->
                <div class="buttons">
                    <button class="control-btn" id="start-btn" onclick="toggleEpisode()">
                        ÂºÄÂßãÊìç‰Ωú
                    </button>
                    <button class="control-btn" onclick="resetEnv()">
                        ÈáçÁΩÆÁéØÂ¢É
                    </button>
                    
                    <!-- Â§πÁà™ÊéßÂà∂Ôºà‰ªÖÊú∫Ê¢∞ËáÇÊ®°ÂºèÊòæÁ§∫Ôºâ -->
                    <div class="gripper-control hidden" id="gripper-control">
                        <label>Â§πÁà™ÊéßÂà∂</label>
                        <input type="range" class="gripper-slider" id="gripper-slider" 
                               min="0" max="100" value="0" onchange="updateGripper()">
                        <div style="font-size: 12px; text-align: center; margin-top: 5px;">
                            <span id="gripper-value">0%</span>
                        </div>
                    </div>

                    <!-- ÊñπÂêë‰º†ÊÑüÂô®‰ø°ÊÅØ -->
                    <div class="sensor-info" id="sensor-info">
                        <div>‰º†ÊÑüÂô®Áä∂ÊÄÅ: <span id="sensor-status">Êú™ÂêØÁî®</span></div>
                        <div>ÂÄæÊñú: <span id="tilt-info">--</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let currentMode = 'base';
        let episodeActive = false;
        let deviceId = Math.random().toString(36).substring(2, 15);
        let socket = null;
        let lastSensorData = { alpha: 0, beta: 0, gamma: 0 };
        let sensorSupported = false;
        
        // ËôöÊãüÊëáÊùÜÁä∂ÊÄÅ
        let joystickActive = false;
        let joystickCenter = { x: 0, y: 0 };
        let joystickValue = { x: 0, y: 0 };
        
        // RTTÁªüËÆ°
        class RTTStats {
            constructor(bufferSize) {
                this.bufferSize = bufferSize;
                this.bufferIndex = 0;
                this.rttArray = new Array(bufferSize).fill(0);
            }

            calculate(rtt) {
                this.rttArray[this.bufferIndex] = rtt;
                this.bufferIndex = (this.bufferIndex + 1) % this.bufferSize;
                const avgRtt = this.rttArray.reduce((acc, cur) => acc + cur, 0) / this.bufferSize;
                return avgRtt.toFixed(1);
            }
        }
        const rttStats = new RTTStats(20);

        // ÂàùÂßãÂåñ
        function init() {
            setupSocket();
            setupJoystick();
            setupSensors();
            updateUI();
        }

        // SocketËøûÊé•
        function setupSocket() {
            socket = io();
            
            socket.on('connect', () => {
                document.getElementById('connection-status').textContent = 'Â∑≤ËøûÊé•';
            });
            
            socket.on('disconnect', () => {
                document.getElementById('connection-status').textContent = 'ËøûÊé•Êñ≠ÂºÄ';
            });
            
            socket.on('echo', (timestamp) => {
                const rtt = Date.now() - timestamp;
                const avgRtt = rttStats.calculate(rtt);
                document.getElementById('rtt-info').textContent = `Âª∂Ëøü: ${avgRtt} ms`;
            });
        }

        // ËÆæÁΩÆËôöÊãüÊëáÊùÜ
        function setupJoystick() {
            const joystick = document.getElementById('joystick');
            const knob = document.getElementById('joystick-knob');
            
            // Ëé∑ÂèñÊëáÊùÜ‰∏≠ÂøÉ‰ΩçÁΩÆ
            function updateJoystickCenter() {
                const rect = joystick.getBoundingClientRect();
                joystickCenter.x = rect.left + rect.width / 2;
                joystickCenter.y = rect.top + rect.height / 2;
            }
            
            // Ëß¶Êë∏ÂºÄÂßã
            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                updateJoystickCenter();
                updateJoystickPosition(e.touches[0]);
            });
            
            // Ëß¶Êë∏ÁßªÂä®
            joystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) {
                    updateJoystickPosition(e.touches[0]);
                }
            });
            
            // Ëß¶Êë∏ÁªìÊùü
            joystick.addEventListener('touchend', (e) => {
                e.preventDefault();
                joystickActive = false;
                joystickValue = { x: 0, y: 0 };
                knob.style.transform = 'translate(-50%, -50%)';
            });
            
            // Èº†Ê†á‰∫ã‰ª∂ÔºàÊ°åÈù¢ÊµãËØïÔºâ
            joystick.addEventListener('mousedown', (e) => {
                joystickActive = true;
                updateJoystickCenter();
                updateJoystickPosition(e);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (joystickActive) {
                    updateJoystickPosition(e);
                }
            });
            
            document.addEventListener('mouseup', () => {
                joystickActive = false;
                joystickValue = { x: 0, y: 0 };
                knob.style.transform = 'translate(-50%, -50%)';
            });
        }
        
        // Êõ¥Êñ∞ÊëáÊùÜ‰ΩçÁΩÆ
        function updateJoystickPosition(pointer) {
            const deltaX = pointer.clientX - joystickCenter.x;
            const deltaY = pointer.clientY - joystickCenter.y;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const maxDistance = 40; // ÊúÄÂ§ßÁßªÂä®Ë∑ùÁ¶ª
            
            let x = deltaX;
            let y = deltaY;
            
            if (distance > maxDistance) {
                x = (deltaX / distance) * maxDistance;
                y = (deltaY / distance) * maxDistance;
            }
            
            // Êõ¥Êñ∞ÊëáÊùÜÊòæÁ§∫
            const knob = document.getElementById('joystick-knob');
            knob.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
            
            // ËÆ°ÁÆóÂΩí‰∏ÄÂåñÂÄº
            joystickValue.x = x / maxDistance;
            joystickValue.y = -y / maxDistance; // YËΩ¥ÂèçÂêë
        }

        // ËÆæÁΩÆ‰º†ÊÑüÂô®
        function setupSensors() {
            if (window.DeviceOrientationEvent) {
                // ËØ∑Ê±ÇÊùÉÈôêÔºàiOS 13+ÈúÄË¶ÅÔºâ
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response == 'granted') {
                                enableSensors();
                            } else {
                                document.getElementById('sensor-status').textContent = 'ÊùÉÈôêË¢´ÊãíÁªù';
                            }
                        });
                } else {
                    enableSensors();
                }
            } else {
                document.getElementById('sensor-status').textContent = '‰∏çÊîØÊåÅ';
            }
        }

        function enableSensors() {
            sensorSupported = true;
            document.getElementById('sensor-status').textContent = 'Â∑≤ÂêØÁî®';
            
            window.addEventListener('deviceorientation', (event) => {
                lastSensorData = {
                    alpha: event.alpha || 0,  // ZËΩ¥ÊóãËΩ¨
                    beta: event.beta || 0,    // XËΩ¥ÊóãËΩ¨
                    gamma: event.gamma || 0   // YËΩ¥ÊóãËΩ¨
                };
                
                document.getElementById('tilt-info').textContent = 
                    `Œ±:${lastSensorData.alpha.toFixed(1)}¬∞ Œ≤:${lastSensorData.beta.toFixed(1)}¬∞ Œ≥:${lastSensorData.gamma.toFixed(1)}¬∞`;
            });
        }

        // ÂàáÊç¢ÊéßÂà∂Ê®°Âºè
        function switchMode(mode) {
            currentMode = mode;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('base-mode-btn').className = 
                mode === 'base' ? 'mode-btn active' : 'mode-btn inactive';
            document.getElementById('arm-mode-btn').className = 
                mode === 'arm' ? 'mode-btn active' : 'mode-btn inactive';
            
            // Êõ¥Êñ∞UI
            updateUI();
        }

        // Êõ¥Êñ∞UI
        function updateUI() {
            const gripperControl = document.getElementById('gripper-control');
            const joystickLabel = document.getElementById('joystick-label');
            
            if (currentMode === 'arm') {
                gripperControl.classList.remove('hidden');
                joystickLabel.textContent = '‰ΩçÁΩÆÊéßÂà∂';
            } else {
                gripperControl.classList.add('hidden');
                joystickLabel.textContent = 'ÁßªÂä®ÊéßÂà∂';
            }
        }

        // ÂàáÊç¢Êìç‰ΩúÁä∂ÊÄÅ
        function toggleEpisode() {
            const btn = document.getElementById('start-btn');
            if (!episodeActive) {
                episodeActive = true;
                btn.textContent = 'ÁªìÊùüÊìç‰Ωú';
                btn.style.background = '#F44336';
                sendCommand('episode_started');
            } else {
                episodeActive = false;
                btn.textContent = 'ÂºÄÂßãÊìç‰Ωú';
                btn.style.background = 'rgba(255,255,255,0.2)';
                sendCommand('episode_ended');
            }
        }

        // ÈáçÁΩÆÁéØÂ¢É
        function resetEnv() {
            episodeActive = false;
            document.getElementById('start-btn').textContent = 'ÂºÄÂßãÊìç‰Ωú';
            document.getElementById('start-btn').style.background = 'rgba(255,255,255,0.2)';
            sendCommand('reset_env');
        }

        // Êõ¥Êñ∞Â§πÁà™
        function updateGripper() {
            const slider = document.getElementById('gripper-slider');
            const value = slider.value;
            document.getElementById('gripper-value').textContent = `${value}%`;
        }

        // ÂèëÈÄÅÂëΩ‰ª§
        function sendCommand(command) {
            if (socket) {
                socket.emit('message', {
                    timestamp: Date.now(),
                    device_id: deviceId,
                    state_update: command
                });
            }
        }

        // ÂèëÈÄÅÊéßÂà∂Êï∞ÊçÆ
        function sendControlData() {
            if (!socket || !episodeActive) return;
            
            let controlData = {
                timestamp: Date.now(),
                device_id: deviceId,
                teleop_mode: currentMode
            };
            
            if (currentMode === 'base') {
                // Â∫ïÁõòÊéßÂà∂ÔºöÊëáÊùÜÊéßÂà∂ÁßªÂä®Ôºå‰º†ÊÑüÂô®ÊéßÂà∂ÊóãËΩ¨
                controlData.position = {
                    x: joystickValue.x * 0.1,  // Áº©ÊîæÂà∞ÂêàÈÄÇËåÉÂõ¥
                    y: joystickValue.y * 0.1,
                    z: 0
                };
                controlData.orientation = {
                    x: 0,
                    y: 0,
                    z: sensorSupported ? lastSensorData.gamma * 0.01 : 0,
                    w: 1
                };
            } else {
                // Êú∫Ê¢∞ËáÇÊéßÂà∂ÔºöÊëáÊùÜÊéßÂà∂XYÔºå‰º†ÊÑüÂô®ÊéßÂà∂Z
                controlData.position = {
                    x: joystickValue.x * 0.05,
                    y: joystickValue.y * 0.05,
                    z: sensorSupported ? lastSensorData.beta * 0.002 : 0
                };
                controlData.orientation = {
                    x: 0,
                    y: 0,
                    z: 0,
                    w: 1
                };
                
                // Â§πÁà™ÊéßÂà∂
                const gripperSlider = document.getElementById('gripper-slider');
                controlData.gripper_delta = (gripperSlider.value - 50) / 50; // -1Âà∞1
            }
            
            socket.emit('message', controlData);
        }

        // ÂÆöÊúüÂèëÈÄÅÊéßÂà∂Êï∞ÊçÆ
        setInterval(sendControlData, 50); // 20Hz

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        window.addEventListener('load', init);

        // Èò≤Ê≠¢È°µÈù¢ÊªöÂä®
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html> 