<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TidyBot2 åº•ç›˜è°ƒè¯•ç•Œé¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            overflow-x: auto;
        }

        .header {
            text-align: center;
            color: #00ffff;
            margin-bottom: 20px;
        }

        .debug-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .debug-section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
        }

        .section-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .debug-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 12px;
        }

        .debug-value {
            color: #00ff88;
            font-weight: bold;
        }

        .log-panel {
            background: #000;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 2px 0;
            font-size: 11px;
        }

        .log-timestamp {
            color: #888;
        }

        .log-info { color: #00ff00; }
        .log-warning { color: #ffff00; }
        .log-error { color: #ff4444; }

        @media (max-width: 768px) {
            .debug-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– TidyBot2 åº•ç›˜æ§åˆ¶è°ƒè¯•ç•Œé¢</h1>
        <div id="connectionStatus">è¿æ¥çŠ¶æ€: <span id="statusText">è¿æ¥ä¸­...</span></div>
    </div>

    <div class="debug-panel">
        <div class="debug-section">
            <div class="section-title">åº•ç›˜çŠ¶æ€</div>
            <div class="debug-item">
                <span>ä½ç½® X:</span>
                <span class="debug-value" id="posX">0.000 m</span>
            </div>
            <div class="debug-item">
                <span>ä½ç½® Y:</span>
                <span class="debug-value" id="posY">0.000 m</span>
            </div>
            <div class="debug-item">
                <span>è§’åº¦ Î¸:</span>
                <span class="debug-value" id="posTheta">0.000 rad</span>
            </div>
            <div class="debug-item">
                <span>çº¿é€Ÿåº¦ X:</span>
                <span class="debug-value" id="velX">0.000 m/s</span>
            </div>
            <div class="debug-item">
                <span>çº¿é€Ÿåº¦ Y:</span>
                <span class="debug-value" id="velY">0.000 m/s</span>
            </div>
            <div class="debug-item">
                <span>è§’é€Ÿåº¦ Z:</span>
                <span class="debug-value" id="velZ">0.000 rad/s</span>
            </div>
        </div>

        <div class="debug-section">
            <div class="section-title">æ§åˆ¶è¾“å…¥</div>
            <div class="debug-item">
                <span>ç§»åŠ¨ X:</span>
                <span class="debug-value" id="joyX">0.000</span>
            </div>
            <div class="debug-item">
                <span>ç§»åŠ¨ Y:</span>
                <span class="debug-value" id="joyY">0.000</span>
            </div>
            <div class="debug-item">
                <span>æ—‹è½¬æ–¹å‘:</span>
                <span class="debug-value" id="joyZ">åœæ­¢</span>
            </div>
            <div class="debug-item">
                <span>çº¿é€Ÿåº¦æ¯”ä¾‹:</span>
                <span class="debug-value" id="linearScale">0.80</span>
            </div>
            <div class="debug-item">
                <span>è§’é€Ÿåº¦æ¯”ä¾‹:</span>
                <span class="debug-value" id="angularScale">0.80</span>
            </div>
            <div class="debug-item">
                <span>æ§åˆ¶æ¨¡å¼:</span>
                <span class="debug-value" id="controlMode">æ‘‡æ†+æŒ‰é’®</span>
            </div>
        </div>

        <div class="debug-section">
            <div class="section-title">ç›®æ ‡é€Ÿåº¦</div>
            <div class="debug-item">
                <span>ç›®æ ‡ VX:</span>
                <span class="debug-value" id="targetVX">0.000 m/s</span>
            </div>
            <div class="debug-item">
                <span>ç›®æ ‡ VY:</span>
                <span class="debug-value" id="targetVY">0.000 m/s</span>
            </div>
            <div class="debug-item">
                <span>ç›®æ ‡ WZ:</span>
                <span class="debug-value" id="targetWZ">0.000 rad/s</span>
            </div>
            <div class="debug-item">
                <span>çº¿é€Ÿåº¦å¹…å€¼:</span>
                <span class="debug-value" id="linearMag">0.000 m/s</span>
            </div>
            <div class="debug-item">
                <span>è§’é€Ÿåº¦å¹…å€¼:</span>
                <span class="debug-value" id="angularMag">0.000 rad/s</span>
            </div>
        </div>

        <div class="debug-section">
            <div class="section-title">ç³»ç»ŸçŠ¶æ€</div>
            <div class="debug-item">
                <span>æ“ä½œçŠ¶æ€:</span>
                <span class="debug-value" id="episodeStatus">éæ´»åŠ¨</span>
            </div>
            <div class="debug-item">
                <span>ç´§æ€¥åœæ­¢:</span>
                <span class="debug-value" id="emergencyStatus">å¦</span>
            </div>
            <div class="debug-item">
                <span>çœç”µæ¨¡å¼:</span>
                <span class="debug-value" id="powerSave">å¦</span>
            </div>
            <div class="debug-item">
                <span>æ§åˆ¶é¢‘ç‡:</span>
                <span class="debug-value" id="controlFreq">0 Hz</span>
            </div>
            <div class="debug-item">
                <span>ç¼“å­˜å¤§å°:</span>
                <span class="debug-value" id="cacheSize">0</span>
            </div>
        </div>
    </div>

    <div class="debug-section">
        <div class="section-title">å®æ—¶æ—¥å¿—</div>
        <div class="log-panel" id="logPanel">
            <div class="log-entry log-info">
                <span class="log-timestamp">[å¯åŠ¨]</span> è°ƒè¯•ç•Œé¢å·²åˆå§‹åŒ–
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let lastUpdateTime = 0;
        let updateCount = 0;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            startUpdateLoop();
        });

        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus(true);
                addLogEntry('info', 'å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                addLogEntry('error', 'ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
            });

            socket.on('base_config', function(data) {
                addLogEntry('info', `æ¥æ”¶åˆ°åº•ç›˜é…ç½®: ${JSON.stringify(data)}`);
            });

            socket.on('base_status', function(data) {
                updateDebugDisplay(data);
                updateCount++;
            });

            socket.on('performance_stats', function(data) {
                addLogEntry('info', `æ€§èƒ½ç»Ÿè®¡: CPU=${data.cpu_percent}% å†…å­˜=${data.memory_percent}%`);
            });
        }

        function updateConnectionStatus(connected) {
            const statusText = document.getElementById('statusText');
            if (connected) {
                statusText.textContent = 'å·²è¿æ¥';
                statusText.style.color = '#00ff00';
            } else {
                statusText.textContent = 'æ–­å¼€è¿æ¥';
                statusText.style.color = '#ff4444';
            }
        }

        function updateDebugDisplay(data) {
            // ä½ç½®ä¿¡æ¯
            if (data.position) {
                document.getElementById('posX').textContent = `${data.position.x.toFixed(3)} m`;
                document.getElementById('posY').textContent = `${data.position.y.toFixed(3)} m`;
                document.getElementById('posTheta').textContent = `${data.position.theta.toFixed(3)} rad`;
            }

            // é€Ÿåº¦ä¿¡æ¯
            if (data.velocity) {
                document.getElementById('velX').textContent = `${data.velocity.vx.toFixed(3)} m/s`;
                document.getElementById('velY').textContent = `${data.velocity.vy.toFixed(3)} m/s`;
                document.getElementById('velZ').textContent = `${data.velocity.wz.toFixed(3)} rad/s`;
            }

            // ç›®æ ‡é€Ÿåº¦
            if (data.target_velocity) {
                document.getElementById('targetVX').textContent = `${data.target_velocity.vx.toFixed(3)} m/s`;
                document.getElementById('targetVY').textContent = `${data.target_velocity.vy.toFixed(3)} m/s`;
                document.getElementById('targetWZ').textContent = `${data.target_velocity.wz.toFixed(3)} rad/s`;
                
                const linearMag = Math.sqrt(data.target_velocity.vx ** 2 + data.target_velocity.vy ** 2);
                document.getElementById('linearMag').textContent = `${linearMag.toFixed(3)} m/s`;
                document.getElementById('angularMag').textContent = `${Math.abs(data.target_velocity.wz).toFixed(3)} rad/s`;
            }

            // æ§åˆ¶è¾“å…¥
            if (data.joystick_input) {
                document.getElementById('joyX').textContent = data.joystick_input.x.toFixed(3);
                document.getElementById('joyY').textContent = data.joystick_input.y.toFixed(3);
                
                // æ—‹è½¬æ–¹å‘æ˜¾ç¤º
                const rotationValue = data.joystick_input.z;
                let rotationText = 'åœæ­¢';
                if (rotationValue > 0) {
                    rotationText = 'é¡ºæ—¶é’ˆ';
                } else if (rotationValue < 0) {
                    rotationText = 'é€†æ—¶é’ˆ';
                }
                document.getElementById('joyZ').textContent = rotationText;
            }

            // é€Ÿåº¦æ¯”ä¾‹
            if (data.speed_scales) {
                document.getElementById('linearScale').textContent = data.speed_scales.linear.toFixed(2);
                document.getElementById('angularScale').textContent = data.speed_scales.angular.toFixed(2);
            }

            // æ§åˆ¶æ¨¡å¼
            if (data.control_mode) {
                document.getElementById('controlMode').textContent = data.control_mode;
            }

            // ç³»ç»ŸçŠ¶æ€
            document.getElementById('emergencyStatus').textContent = data.emergency_stop ? 'æ˜¯' : 'å¦';
            document.getElementById('emergencyStatus').style.color = data.emergency_stop ? '#ff4444' : '#00ff88';
        }

        function startUpdateLoop() {
            setInterval(() => {
                const currentTime = Date.now();
                if (lastUpdateTime > 0) {
                    const freq = 1000 / (currentTime - lastUpdateTime);
                    document.getElementById('controlFreq').textContent = `${freq.toFixed(1)} Hz`;
                }
                lastUpdateTime = currentTime;
            }, 100);

            // è¯·æ±‚è¯¦ç»†çŠ¶æ€
            setInterval(() => {
                if (socket && socket.connected) {
                    fetch('/status')
                        .then(response => response.json())
                        .then(data => {
                            if (data.base_status) {
                                updateSystemStatus(data.base_status);
                            }
                        })
                        .catch(error => {
                            addLogEntry('error', `è·å–çŠ¶æ€å¤±è´¥: ${error.message}`);
                        });
                }
            }, 1000);
        }

        function updateSystemStatus(status) {
            document.getElementById('episodeStatus').textContent = status.episode_active ? 'æ´»åŠ¨' : 'éæ´»åŠ¨';
            document.getElementById('episodeStatus').style.color = status.episode_active ? '#00ff88' : '#ffbb33';
            
            document.getElementById('powerSave').textContent = status.power_save_mode ? 'æ˜¯' : 'å¦';
            document.getElementById('powerSave').style.color = status.power_save_mode ? '#ffbb33' : '#00ff88';
            
            document.getElementById('cacheSize').textContent = status.cache_size || 0;
        }

        function addLogEntry(level, message) {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level}`;
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
            while (logPanel.children.length > 100) {
                logPanel.removeChild(logPanel.firstChild);
            }
        }

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            addLogEntry('error', `JavaScripté”™è¯¯: ${e.message}`);
        });
    </script>
</body>
</html> 